<!DOCTYPE html>
<html>
<head>
  <title>Editor</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
  <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
  <script src="https://unpkg.com/@blockly/field-colour/dist/index.js"></script>
  <style>
    /* Ensure full screen without margins or padding */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #blocklyDiv {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    #runButton {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 999;
      font-size: 16px;
      padding: 10px 20px;
      border-style: hidden;
      color: white;
      background-color: lime
    }
  </style>
</head>
<body>
  <!-- Define workspace container -->
  <div id="blocklyDiv"></div>

  <!-- Define Run button -->
  <button id="runButton">Run</button>

  <!-- Define toolbox -->
  <xml id="toolbox" style="display: none">
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="Loops">
      <block type="controls_repeat_ext"></block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for"></block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_modulo"></block>
      <block type="math_constrain"></block>
      <block type="math_random_int"></block>
      <block type="math_random_float"></block>
      <block type="math_atan2"></block>
    </category>
    <category name="Text">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append"></block>
      <block type="text_length"></block>
      <block type="text_isEmpty"></block>
      <block type="text_indexOf"></block>
      <block type="text_charAt"></block>
      <block type="text_getSubstring"></block>
      <block type="text_changeCase"></block>
      <block type="text_trim"></block>
      <block type="text_print"></block>
    </category>
    <category name="Lists">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat"></block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_getSublist"></block>
      <block type="lists_split"></block>
      <block type="lists_sort"></block>
    </category>
    <category name="Colour">
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb"></block>
      <block type="colour_blend"></block>
    </category>
    <category name="Variables" custom="VARIABLE"></category>
    <category name="Functions" custom="PROCEDURE"></category>
    <category name="Events">
      <block type="event_key_pressed"></block>
      <block type="event_script_ran"></block>
    </category>
    <category name="Actions">
      <block type="action_change_bg_color"></block>
      <block type="action_show_alert"></block>
      <block type="action_log_message"></block>
    </category>
  </xml>

  <script>
    // Define custom event blocks
    Blockly.Blocks['event_key_pressed'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("when")
            .appendField(new Blockly.FieldDropdown([
              ["a","a"], ["b","b"], ["c","c"], ["d","d"], ["e","e"],
              ["f","f"], ["g","g"], ["h","h"], ["i","i"], ["j","j"],
              ["k","k"], ["l","l"], ["m","m"], ["n","n"], ["o","o"],
              ["p","p"], ["q","q"], ["r","r"], ["s","s"], ["t","t"],
              ["u","u"], ["v","v"], ["w","w"], ["x","x"], ["y","y"],
              ["z","z"], ["Space"," "], ["Left Arrow", "ArrowLeft"], ["Right Arrow", "ArrowRight"],
              ["Up Arrow", "ArrowUp"], ["Down Arrow", "ArrowDown"]
            ]), "KEY")
            .appendField("key pressed");
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['event_script_ran'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("when script ran");
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };

    // Define custom action blocks
    Blockly.Blocks['action_change_bg_color'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("change background color to")
            .appendField(new Blockly.FieldColour("#ff0000"), "COLOR");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(160);
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['action_show_alert'] = {
      init: function() {
        this.appendValueInput("TEXT")
            .setCheck("String")
            .appendField("show alert with message");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(160);
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['action_log_message'] = {
      init: function() {
        this.appendValueInput("TEXT")
            .setCheck("String")
            .appendField("log message");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(160);
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };

    // Define JavaScript generators for custom action blocks
    Blockly.JavaScript['action_change_bg_color'] = function(block) {
      var color = block.getFieldValue('COLOR');
      var code = `document.body.style.backgroundColor = '${color}';\n`;
      return code;
    };

    Blockly.JavaScript['action_show_alert'] = function(block) {
      var text = Blockly.JavaScript.valueToCode(block, 'TEXT', Blockly.JavaScript.ORDER_ATOMIC);
      var code = `alert(${text});\n`;
      return code;
    };

    Blockly.JavaScript['action_log_message'] = function(block) {
      var text = Blockly.JavaScript.valueToCode(block, 'TEXT', Blockly.JavaScript.ORDER_ATOMIC);
      var code = `console.log(${text});\n`;
      return code;
    };

    // Initialize Blockly with zoom controls
    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      grid: {
        spacing: 20,
        length: 1,
        colour: '#ddd',
        snap: true
      },
      zoom: {
        controls: true,
        wheel: true,
        startScale: 1.0,
        maxScale: 3,
        minScale: 0.3,
        scaleSpeed: 1.2
      }
    });

    // Define the function to run the code below the 'when script ran' block
    function runCode() {
      // Clear console
      console.clear();

      // Get all blocks
      const allBlocks = workspace.getTopBlocks(true);
      // Find all 'when script ran' blocks
      const eventScriptRanBlocks = allBlocks.filter(block => block.type === 'event_script_ran');
      // Execute the blocks connected to 'when script ran'
      eventScriptRanBlocks.forEach(block => {
        let code = '';
        let nextBlock = block.getNextBlock();
        while (nextBlock) {
          code += Blockly.JavaScript.blockToCode(nextBlock);
          nextBlock = nextBlock.getNextBlock();
        }
        try {
          eval(code);
        } catch (e) {
          console.error('Error executing block code:', e);
        }
      });
    }

    // Attach event listener to the Run button
    document.getElementById('runButton').addEventListener('click', runCode);
  </script>
</body>
</html>
